<html>
	<head>
		<title>Filters Fast</title>
		<link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
		<script src="https://integrations.missiveapp.com/missive.js"></script>
	</head>
	<body style="height:90%">
		<!---------------------------HEADER--------------------------------->
		<div class="column-vertical padding margin section" style="border-radius:4px;background-color: rgba(125, 127, 125, 0.1)">
			<table cellspacing="0" cellpadding="0" style="margin:auto;border:none">
			  <tr>
				<td rowspan="2"><img id="avatar" style="margin-right:8px;border:3px solid var(--missive-text-color-a);display:block; height:54px; border-radius:32px" src="profileplaceholder.png"></td>
				<td id="name" class="text-xlarge text-600"></td>
			  </tr>
			  <tr>
				<td id="layout" style="vertical-align:top;font-style: italic" class="text-small text-c"></td>
			  </tr>
			</table>
		</div>
		<!---------------------------VERSION---------------------------------->
		<div class="column-vertical column-center margin section align-center">
			<span class="button-link column padding" id="reload-button">Version 38.9</span>
		</div>
		<!-------------------------------------------------------------------->
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-subject">Get M Subject</span></td>
					<td><span class="columnn" id="subject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-cSubject">Get C Subject</span></td>
					<td><span class="columnn" id="cSubject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-labels">Get Labels</span></td>
					<td><span class="columnn" id="labels-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-replyto">Get Reply Email</span></td>
					<td><span class="columnn" id="replyto-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="create-task">Create a task</span></td>
					<td><span class="columnn" id="task-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-msgcount">Get Msg Count</span></td>
					<td><span class="columnn" id="msgcount-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-from">Get From</span></td>
					<td><span class="columnn" id="from-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-draft">Get Draft Status</span></td>
					<td><span class="columnn" id="draft-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		
		<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			//======== create a function that can be reused as needed ========
			var currentUser;
			var fullName;
			var profileType = "master"; //CCA, CRM, master
			var currentConvo;
			var currentnMessage;
			var messageSubject;
			var convoSubject;
			var convoLink
			var messageCount;
			var msgTo;
			var msgFrom;
			var draft;
			$(document).ready((ids) => {Missive.fetchUsers().then((users) => {
					$(users).each(function(){
						if(this.me){
							currentUser = this;
							var fullName = currentUser.first_name + " " + currentUser.last_name;
							$("#avatar").attr("src",currentUser.avatar_url);
							$("#layout").text(title);
							$("#name").text(fullName);
						}
					});	
				})
				var title;
				if (profileType == "master") {
    				title = "Administrator"
				} else if (profileType == "Client Relationship Manager"){
    				title = "Client Relationship Manager"
				} else {
					title = "Customer Care Advocate"
				}
				
				
				// if CCA show all CCA-specific items

				// if CRM show all CRM-specific items

				// if Master, show everything with a toggle to go between
				/*Missive.fetchConversations(ids).then((conversations) => {
					if (conversations.length != 1) {
					// Do nothing if multiple conversations are selected.
					return
					}
					currentMessage = conversations[0].latest_message
					currentConvo = conversations[0]
				})*/
			})
			Missive.on('change:conversations', (ids) => {
				Missive.fetchConversations(ids).then((conversations) => {
				//	if (conversations.length != 1) {
					// Do nothing if multiple conversations are selected.
				//	return
				//}
					currentConvo = conversations[0]
					currentMessage = currentConvo.latest_message
					messageCount = currentConvo.messages_count
					msgTo = currentMessage.to_fields[0]
					//msgFrom = "NOFROM";/// is this needed??************************************************************************************
					//if (!currentMessage || !currentMessage.from_field){
						
					//}else{
					//	msgFrom = currentMessage.from_field.address;
					//}
					//if(typeof currentMessage.subject === 'undefined'){
					//	messageSubject = "NOSUBJECT";
					//}else{
					//	messageSubject = currentMessage.subject	
					//}

					var isdraft = "YES"
						
					var message = conversations[0].latest_message
					if (!message || !message.from_field) {
					// Do nothing if conversation has no message (only chat comments) or if
					// message has no From field.
					isdraft = "NO"
					return
					}

					$("#draft-text").text(isdraft)
					
				


				})
			})
			
			function getUser() {
				return currentUser;
			}
			function getSubject(some_param){
  				
				//var x;
				
			}
			function getCSubject(){
  				//======== parameters go here. this one does nothing, but serves as a placeholder ========
				var x = currentConvo; // this is never used
				//======== return the end result ========
				return x.subject;
			}
			function getLabels() {
  				//======== no parameters this time ========
				var x = messageSubject;
				return x;
			}
			function getReplyTo() {
  				//======== no parameters this time ========
				return "Get reply to email address (function not defined)";
			}
			function createTask() {
  				//======== no parameters this time ========
				return "Create a task (function not defined)";
			}
			function getMsgCount() {
				var count;
				//if(!currentConvo.messages_count){
				//	messageSubject = "[empty]";
				//} else {
					count = currentConvo.messages_count;
				//}
				return count;
			}
			function getFrom(){
				if(!currentConvo.latest_message || !currentConvo.latest_message.from_field){
					messageSubject = "[empty]";
				} else {
					messageSubject = currentConvo.latest_message.from_field.address;
				}
				return messageSubject;
			}
			function assignDraft(input){
				var from = getFrom();
				var count = getMsgCount();
				if((from == "[empty]") && (count < 2)){
					Missive.assign(currentUser.id)
				}			
			}
			//======== button to test that funciton works ========
			$("#get-subject").click(function () { 
				//======== run the function, optionally with parameters ========
				var value = getSubject("anything-goes-here");
				//======== write the value to the text next to the button to test that it works ========
				$("#subject-text").text(value);
			});
			//======== button to test that funciton works ========
			$("#get-cSubject").click(function () { 
				//======== run the function, no parameters ========
				var value = getCSubject();
				$("#cSubject-text").text(value);
			});
			$("#get-labels").click(function () { 
				//======== run the function, no parameters ========
				var value = getLabels();
				$("#labels-text").text(value);
			});
			$("#get-replyto").click(function () { 
				//======== run the function, no parameters ========
				var value = getReplyTo();
				$("#replyto-text").text(value);
			});
			$("#create-task").click(function () { 
				var value = createTask();
				$("#task-text").text(value);
			});
			$("#get-msgcount").click(function () { 
				var value = getMsgCount();
				$("#msgcount-text").text(value);
			});
			$("#get-from").click(function () { 
				var value = getFrom();
				$("#from-text").text(value);
			});
			$("#get-draft").click(function () { 
				assignDraft(currentConvo);
			});
			$("#reload-button").click(function () { 
				Missive.reload();
			});
		</script>
	</body>
</html>