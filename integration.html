<html>
	<head>
		<title>Filters Fast</title>
		<link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
		<link href="profile-visibility.css" rel="stylesheet">
		<script src="https://integrations.missiveapp.com/missive.js"></script>
	</head>
	<body style="height:90%">
		<!---------------------------HEADER--------------------------------->
		<div class="column-vertical padding margin section" style="border-radius:4px;background-color: rgba(125, 127, 125, 0.1)">
			<table cellspacing="0" cellpadding="0" style="margin:auto;border:none">
			  <tr>
				<td rowspan="2"><span id="avatar" style="border:3px solid var(--missive-text-color-a);display:block;background-image: url('profileplaceholder.png');height:54px;width:54px;background-size:cover;background-position: center center;border-radius:32px"></span></td>
				<td><span id="name" style="margin-left:8px" class="text-xlarge text-600"></span></td>
			  </tr>
			  <tr>
				<td><span id="layout" style="margin-left:8px;vertical-align:top;font-style: italic" class="text-small text-c"></span></td>
			  </tr>
			</table>
		</div>
		<div class="column-vertical column-center margin section align-center">
			<!---------------------------  [[  VERSION  ]]  ------------------------------->
			<span class="button-link column padding" id="reload-button">Version 68</span>
			<!----------------------------------------------------------------------------->
		</div>
		<!-- monday main board search: https://filtersfast.monday.com/boards/650367267/pulses/6430604454?term=
			from_field.customer_id will this work???? 
			things to test:
				crop icons to square
				empty labels: Archive, Sent, Assigned, Unasigned Closed
				make monday form link with order number
				make monday search with order number
				differentiate between number of SENT messages and number of RECEIVED messages (>1 would produce "thank you
					for your reply"), see whether the first message was sent/received, last messages as well
				if at least 1 message is from @filtersfast.com and to != @filtersfast.com (sent to cust by FF) and the most
					recent message is the inverse (sent to FF by cust), thank you for your reply. also, account messages 
					sent from other inboxes, which will appear as though they were received from customers.
				unlabel chatbot request after sending
		-->
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-preview">Get Msg Preview</span></td>
					<td><span class="columnn" id="preview-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-messageSubject">Get Msg Subject</span></td>
					<td><span class="columnn" id="messageSubject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-conversationSubject">Get Convo Subject</span></td>
					<td><span class="columnn" id="conversationSubject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-to">Get To</span></td>
					<td><span class="columnn" id="to-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-from">Get From</span></td>
					<td><span class="columnn" id="from-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-labels">Get Labels</span></td>
					<td><span class="columnn" id="labels-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-messageCount">Get Msg Count</span></td>
					<td><span class="columnn" id="messageCount-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="create-task">Create a task</span></td>
					<td><span class="columnn" id="task-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-customerID">Get cust ID</span></td>
					<td><span class="columnn" id="customerID-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="CCA-form-button">Get cust ID</span></td>
					<td><span class="columnn" id="CCA-form-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			// ================================ variables ================================
			var currentUser;
			var fullName;
			var crmList = ["fd1f7da207de","a50d68b28cfd","cc4c53720ddf","37e9dbc091a3","f77b171dc34c"]; // (Gema, Isabel, Kaitlyn, Kylee, Alli)
			var adminList = ["dfbf5285907d","eebc81b9f454","aaa5d13aaeb2"] // (Sam, David, Amelia)
			var profileType = "CCA"; // CCA, CRM, master
			var title = "Customer Care Advocate" // default, unless  otherwise specified
			var currentConvo;
			var messagePreview;
			var messageSubject;
			var convoSubject;
			var msgTo;
			var msgFrom;
			var labelsArray = [];
			var messageCount;
			var convoLink;
			var replied; // change this to "replied" with a value of true/false
			// ========================== on load function ===============================
			$(document).ready((ids) => {Missive.fetchUsers().then((users) => {
					$(users).each(function(){
						if(this.me){
							currentUser = this;
						}
					});
					$(adminList).each(function(){
						if(this == currentUser.id.split("-")[4]){
							profileType = "master"
							title = "Administrator";
						}
					});
					$(crmList).each(function(){
						if(this == currentUser.id.split("-")[4]){
							profileType = "CRM"
							title = "Client Relationship Manager";
							// set style sheets accordingly
						}
					})
					var fullName = currentUser.first_name + " " + currentUser.last_name;
					$("#avatar").css("background-image","url(" + currentUser.avatar_url + ")");
					$("#name").text(fullName);
					$("#layout").text(title);
				})				
			})
			Missive.on('change:conversations', (ids) => {
				Missive.fetchConversations(ids).then((conversations) => {
					// If no messages have been sent or received in the current conversation, it is a new draft				
					currentConvo = conversations[0];
					replied = false;
					update(currentConvo);
					showResults();
				})
			})
			function getUser() {
				return currentUser;
			}
			function getPreview(conversation){
				if(conversation.messages.length == 0){
					return "[empty]"
				}
				else {
					$("#preview-text").html("<div>" + "Hello!" + "</div>")
					//return bodyText2;
				}
			}
			function getMessageSubject(conversation){
				if(conversation.messages.length == 0){
					return "[empty]"
				}
				else {
					return conversation.latest_message.subject;
				}
			}
			function getConversationSubject(conversation){
				if(conversation.messages.length == 0){
					return "[empty]";
				}
				else {
					return conversation.subject;
				}
			}
			function getTo(conversation){
					if(conversation.messages.length == 0){
					return "[empty]";
				}
				else {
					return conversation.latest_message.to_fields[0].address;
				}
			}
			function getFrom(conversation) {
				if(conversation.messages.length == 0){
					return "[empty]";
				}
				else {
					if(conversation.latest_message.from_field.address == "boldsales@filtersfast.com"){
						return (conversation.latest_message.body.split("</a>")[0]).split("<")[1];
					}
					else{
						return conversation.latest_message.from_field.address;
					}
				}
			}
			function getLabels(conversation){				
				var labels = ["No labels"]
				replied = false;
				for ( var i = 0, labelCount = conversation.labels.length; i < labelCount; i++ ) {	
					var prefix = conversation.labels[i].id.split("-")[0];
					if(prefix != "closed" && prefix != "assigned" && prefix != "assigned_to_others" && prefix != "unassigned" && prefix != "archive"){
						if(prefix == "sent"){
							replied = true;
						}
						else{
							labels.push(conversation.labels[i].name) // this can be .name or .id
						}
					}
				}
				if(labels.length > 1){
					labels.shift();
				}
				return labels +  " | " + replied;
			}
			function getMessageCount(conversation) {
				if(conversation.messages.length == 0){
					return 0;
				}
				else {
					return conversation.messages_count;
				}
			}
			function getCustomerID(conversation) {
				if(conversation.messages.length == 0){
					return "[empty]";
				}
				//else {						
				//}
			}
			function task(text) {
				Missive.createTask(text,false);
			}
			function assignDraft(conversation) {
				if(conversation.messages.length == 0 && conversation.assignees.length == 0){
					Missive.assign(currentUser.id);
				}
			}
			function update(input){
				//messagePreview = getPreview(input);
				//messageSubject = getMessageSubject(input);
				//convoSubject = getConversationSubject(input);
				//msgTo = getTo(input);
				//msgFrom = getFrom(input);
				labelsArray = getLabels(input);				
				//messageCount = getMessageCount(input);				
				//assignDraft(input);
			}
			function showResults() {
				//$("#preview-text").text(messagePreview);
				//$("#messageSubject-text").text(messageSubject);
				//$("#messageCount-text").text(messageCount);
				//$("#to-text").text(msgTo);
				//$("#from-text").text(msgFrom);
				//$("#conversationSubject-text").text(convoSubject);
				$("#labels-text").text(labelsArray); // [ THIS CAN BE DELETED, IT IS ONLY USED TO TEST THE LABELS ARRAY]
			}
			function extractContent(s) {
				var span = document.createElement('span');
				span.innerHTML = s;
				return span.textContent || span.innerText;
			};
			function showCCAform(){
				window.location.replace("https://supersam64.github.io/email-integration/form_test.html")
			}
			//======== button to test that function works ========
			$("#get-preview").click(function () {
				
				
				$("#preview-text").text(extractContent(currentConvo.latest_message.body))
				/*const myForm = {
					
						name: "A form",
						comments: [{content: "something"}]
				
							
				}
				Missive.openForm(myForm);*/
			});						
			$("#get-messageSubject").click(function () { 
				//======== run the function, optionally with parameters ========
				var value = getMessageSubject(currentConvo);
				//======== write the value to the text next to the button to test that it works ========
				$("#messageSubject-text").text(value);
			});
			//======== button to test that funciton works ========
			$("#get-conversationSubject").click(function () { 
				//======== run the function, no parameters ========
				var value = getConversationSubject();
				$("#conversationSubject-text").text(value);
			});
			$("#get-to").click(function () { 
				var value = getTo();
				$("#to-text").text(value);
			});
			$("#get-from").click(function () { 
				//======== run the function, no parameters ========
				var value = getFrom();
				$("#from-text").text(value);
			});
			$("#get-labels").click(function () { 
				//======== run the function, no parameters ========
				var value = getLabels();
				$("#labels-text").text(value);
			});
			$("#get-messageCount").click(function () { 
				var value = getMessageCount();
				$("#messageCount-text").text(value);
			});
			$("#create-task").click(function () { 
				task("This is a task");
			});
			$("#get-customerID").click(function () { 
				var value = getCustomerID(currentConvo);
				$("#customerID-text").text("Done");
			});
			$("#CCA-form-button").click(function () { 
				showCCAform();
			});
			// ================ resets ================
			$("#messageSubject-text").click(function () { 
				//======== run the function, optionally with parameters ========
				var value = getMessageSubject("anything-goes-here");
				//======== write the value to the text next to the button to test that it works ========
				$("#messageSubject-text").text("[RESULT]");
			});
			//======== button to test that funciton works ========
			$("#conversationSubject-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getConversationSubject();
				$("#conversationSubject-text").text("[RESULT]");
			});
			$("#to-text").click(function () { 
				var value = getTo();
				$("#to-text").text("[RESULT]");
			});
			$("#from-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getFrom();
				$("#from-text").text("[RESULT]");
			});
			$("#labels-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getLabels();
				$("#labels-text").text("[RESULT]");
			});
			$("#messageCount-text").click(function () { 
				var value = getMessageCount();
				$("#messageCount-text").text("[RESULT]");
			});
			$("#task-text").click(function () { 
				$("#task-text").text("[RESULT]");
			});
			$("#customerID-text").click(function () { 
				$("#customerID-text").text("[RESULT]");
			});
			// ========================================
			$("#reload-button").click(function () { 
				Missive.reload();
			});
		</script>
	</body>
</html>