<html>
	<head>
		<title>Filters Fast</title>
		<link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
		<link href="profile-visibility.css" rel="stylesheet">
		<script src="https://integrations.missiveapp.com/missive.js"></script>
	</head>
	<body style="height:90%">
		<!---------------------------HEADER--------------------------------->
		<div class="column-vertical padding margin section" style="border-radius:4px;background-color: rgba(125, 127, 125, 0.1)">
			<table cellspacing="0" cellpadding="0" style="margin:auto;border:none">
			  <tr>
				<td rowspan="2"><img id="avatar" style="border:3px solid var(--missive-text-color-a);display:block; height:54px; border-radius:32px" src="profileplaceholder.png"></td>
				<td><span id="name" style="margin-left:8px" class="text-xlarge text-600"></span></td>
			  </tr>
			  <tr>
				<td><span id="layout" style="margin-left:8px;vertical-align:top;font-style: italic" class="text-small text-c"></span></td>
			  </tr>
			</table>
		</div>
		<div class="column-vertical column-center margin section align-center">
			<!---------------------------  [[  VERSION  ]]  ------------------------------->
			<span class="button-link column padding" id="reload-button">Version 54.9</span>
			<!----------------------------------------------------------------------------->
		</div>
		<!-- monday main board search: https://filtersfast.monday.com/boards/650367267/pulses/6430604454?term=
			from_field.customer_id will this work???? 
			things to test:
				empty labels: Archive, Sent, Assigned, Unasigned Closed
				make monday form link with order number
				make monday search with order number
				differentiate between number of SENT messages and number of RECEIVED messages (>1 would produce "thank you for your reply"), see whether the first message was sent/received, last messages as well
		-->
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-subject">Get M Subject</span></td>
					<td><span class="columnn" id="subject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<!-- individual table for row separates left from right, while also still allowing for "section" -->
			<table>
				<tr>
					<td><span class="button column padding" id="get-cSubject">Get C Subject</span></td>
					<td><span class="columnn" id="cSubject-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-labels">Get Labels</span></td>
					<td><span class="columnn" id="labels-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-replyto">Get Reply Email</span></td>
					<td><span class="columnn" id="replyto-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="create-task">Create a task</span></td>
					<td><span class="columnn" id="task-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-msgcount">Get Msg Count</span></td>
					<td><span class="columnn" id="msgcount-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<div class="column-vertical margin section">
			<table>
				<tr>
					<td><span class="button column padding" id="get-to">Get To</span></td>
					<td><span class="columnn" id="to-text" style="word-break: break-all">[RESULT]</span></td>
				</tr>
			</table>
		</div>
		<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			// ================================ variables ================================
			var currentUser;
			var fullName;
			var crmList = ["fd1f7da207de","a50d68b28cfd","cc4c53720ddf","37e9dbc091a3","f77b171dc34c"]; // (Gema, Isabel, Kaitlyn, Kylee, Alli)
			var adminList = ["dfbf5285907d","eebc81b9f454","aaa5d13aaeb2"] // (Sam, David, Amelia)
			var profileType = "CCA"; // CCA, CRM, master
			var title = "Customer Care Advocate" // default, unless  otherwise specified
			var currentnMessage;
			var currentConvo;
			var messageSubject;
			var convoSubject;
			var convoLink;
			var messageCount;
			var msgTo;
			var msgFrom;
			var labelsArray = [];
			var labelsText;
			var labelVar;
			// ========================== on load function ===============================
			$(document).ready((ids) => {Missive.fetchUsers().then((users) => {
					$(users).each(function(){
						if(this.me){
							currentUser = this;
						}
					});
					$(adminList).each(function(){
						if(this == currentUser.id.split("-")[4]){
							profileType = "master"
							title = "Administrator";
						}
					});
					$(crmList).each(function(){
						if(this == currentUser.id.split("-")[4]){
							profileType = "CRM"
							title = "Client Relationship Manager";
							// set style sheets accordingly
						}
					})
					var fullName = currentUser.first_name + " " + currentUser.last_name;
					$("#avatar").attr("src",currentUser.avatar_url);
					$("#name").text(fullName);
					$("#layout").text(title);
				})				
			})
			Missive.on('change:conversations', (ids) => {
				Missive.fetchConversations(ids).then((conversations) => {
					// If no messages have been sent or received in the current conversation, it is a new draft
					currentConvo = conversations[0];
					if(conversations[0].messages.length == 0){
						currentMessage = "[empty]";
						messageCount = 0;
						msgFrom = "[empty]";
						msgTo = "[empty]";
						messageSubject = "[empty]";
						labelsArray = ["No labels"];
						labelVar7 = labelsArray[0];
						$("#labels-text").text(labelVar7);
						//labelsArray = [];
						//labelsArray.push("No labels")
						//$("#labels-text").text(labelsArray[0]);
						convoSubject = currentConvo.subject;
						if(conversations[0].assignees.length == 0){
							// assign 
							Missive.assign(currentUser.id)
						}
					}
					else {
						currentMessage = currentConvo.latest_message;
						messageCount = currentConvo.messages_count;
						msgFrom = currentConvo.latest_message.from_field.address;
						msgTo = currentConvo.latest_message.to_fields[0].address;
						messageSubject = currentMessage.subject;
						convoSubject = currentConvo.subject;
						//labelVar1 = currentConvo.labels[0].name
						//labelVar2 = currentConvo.labels[1].name
						//labelVar3 = currentConvo.labels[2].name
						labelsArray = []
						labelVar7 = ""
						for ( var i = 0, labelCount = currentConvo.labels.length; i < labelCount; i++ ) {
							//if(!currentConvo.labels[i] || typeof currentConvo.labels[i] == "undefined" || currentConvo.labels[i].name == "No labels" || currentConvo.labels[i].name == "Archive" || currentConvo.labels[i].name == "Sent" || currentConvo.labels[i].name == "Assigned" || currentConvo.labels[i].name == "Unasigned" || currentConvo.labels[i].name == "Closed"){	
								// do nothing | get first part before - and if it is one of 3 things, don't include
							//}
							//else {	
								if(currentConvo.labels[i].id.split("-")[0] != "assigned" && currentConvo.labels[i].id.split("-")[0] != "assigned" && currentConvo.labels[i].id.split("-")[0] != "unassigned" && currentConvo.labels[i].id.split("-")[0] != "archive" && currentConvo.labels[i].id.split("-")[0] != "closed")
								{
									labelsArray.push(currentConvo.labels[i].id)
								}
								//labelVar7 = labelVar7 + labelsArray[i] + " | "
							//}
							var joinedArray = labelsArray.join(" | ");
						}
						//labelVar7 = labelsArray[0] + " " + labelsArray[1] + " " + labelsArray[2]
						//labelVar = currentConvo.labels.length  
						$("#labels-text").text(joinedArray);
					}
					
						//if (labels.length == 0) {
						// Do nothing if multiple conversations are selected.
						//return
						//}
						//Missive.fetchLabels().then((labels) => {
							//$(labels).each(function(){
								//if(this.id == "408dbf5f-8a6f-46dc-8219-c6d0be95345e"){
									//labelsArray.push(this.id);
								//}
							//})
							//$("#labels-text").text(labelsArray[4]);
						//});
					

				})
			})
			function getUser() {
				return currentUser;
			}
			function getSubject(some_param){
				var placeholder = some_param // this is never used, but is an example of how to use parameters
				return messageSubject;
			}
			function getCSubject(){
				//======== no parameters this time ========
				return convoSubject;
			}
			function getLabels() {
				var labels = someIDvar[4];
				return labels;
			}
			function getReplyTo() {
				return msgFrom;
			}
			function createTask() {
				return "Create a task (function not defined)";
			}
			function getMsgCount() {
				return messageCount;
			}
			function getTo(){
				return msgTo;
			}
			//======== button to test that function works ========
			$("#get-subject").click(function () { 
				//======== run the function, optionally with parameters ========
				var value = getSubject("anything-goes-here");
				//======== write the value to the text next to the button to test that it works ========
				$("#subject-text").text(value);
			});
			//======== button to test that funciton works ========
			$("#get-cSubject").click(function () { 
				//======== run the function, no parameters ========
				var value = getCSubject();
				$("#cSubject-text").text(value);
			});
			$("#get-labels").click(function () { 
				//======== run the function, no parameters ========
				var value = getLabels();
				$("#labels-text").text(value);
			});
			$("#get-replyto").click(function () { 
				//======== run the function, no parameters ========
				var value = getReplyTo();
				$("#replyto-text").text(value);
			});
			$("#create-task").click(function () { 
				var value = createTask();
				$("#task-text").text(value);
			});
			$("#get-msgcount").click(function () { 
				var value = getMsgCount();
				$("#msgcount-text").text(value);
			});
			$("#get-to").click(function () { 
				var value = getTo();
				$("#to-text").text(value);
			});
			// ================ resets ================
			$("#subject-text").click(function () { 
				//======== run the function, optionally with parameters ========
				var value = getSubject("anything-goes-here");
				//======== write the value to the text next to the button to test that it works ========
				$("#subject-text").text("[RESULT]");
			});
			//======== button to test that funciton works ========
			$("#cSubject-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getCSubject();
				$("#cSubject-text").text("[RESULT]");
			});
			$("#labels-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getLabels();
				$("#labels-text").text("[RESULT]");
			});
			$("#replyto-text").click(function () { 
				//======== run the function, no parameters ========
				var value = getReplyTo();
				$("#replyto-text").text("[RESULT]");
			});
			$("#task-text").click(function () { 
				var value = createTask();
				$("#task-text").text("[RESULT]");
			});
			$("#msgcount-text").click(function () { 
				var value = getMsgCount();
				$("#msgcount-text").text("[RESULT]");
			});
			$("#to-text").click(function () { 
				var value = getTo();
				$("#to-text").text("[RESULT]");
			});
			// ========================================
			$("#reload-button").click(function () { 
				Missive.reload();
			});
		</script>
	</body>
</html>